<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fast GPT Chatbot</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body, html {
            height: 100%;
            overflow: hidden;
            background: #f8f9fa;
        }
        #chat-container {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        #sidebar {
            width: 280px;
            background: #343a40;
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 10;
        }
        #sidebar.hide {
            transform: translateX(-100%);
        }
        #sidebar-header {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            border-bottom: 1px solid #495057;
            user-select: none;
        }
        #chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        #chat-list button {
            width: 100%;
            color: white;
            text-align: left;
            border-radius: 0;
            border: none;
            padding: 0.75rem 1rem;
            background: transparent;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        #chat-list button:hover,
        #chat-list button.active {
            background-color: #495057;
        }
        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
        }
        #chat-header {
            padding: 1rem;
            background: #0d6efd;
            color: white;
            font-weight: 600;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            scroll-behavior: smooth;
        }
        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 15px;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease;
        }
        .message.user {
            align-self: flex-end;
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 0;
        }
        .message.bot {
            align-self: flex-start;
            background-color: #e9ecef;
            color: #212529;
            border-bottom-left-radius: 0;
        }
        #input-area {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            background: #f8f9fa;
        }
        #input-area textarea {
            resize: none;
            flex-grow: 1;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid #ced4da;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        #input-area textarea:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.5);
        }
        #input-area button {
            background-color: #0d6efd;
            border: none;
            color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #input-area button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #toggle-sidebar-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 0.5rem;
            display: none;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(-100%);
            }
            #sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            #toggle-sidebar-btn {
                display: inline-block;
            }
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1; transform: translateY(0);}
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <nav id="sidebar" class="hide">
            <div id="sidebar-header">
                Chats
                <button id="add-chat" class="btn btn-sm btn-light float-end" title="Nuevo chat" style="font-weight: 600;">+</button>
            </div>
            <div id="chat-list" class="list-group"></div>
        </nav>

        <main id="main-chat" class="d-flex flex-column">
            <header id="chat-header">
                <button id="toggle-sidebar-btn" title="Mostrar/Ocultar chats">&#9776;</button>
                <span id="chat-title">Chat Nuevo</span>
                <button id="delete-chat" class="btn btn-danger btn-sm" title="Eliminar chat">üóëÔ∏è</button>
            </header>

            <div id="messages"></div>

            <form id="input-area" autocomplete="off">
                <textarea id="input-message" rows="1" placeholder="Escribe tu mensaje..." required></textarea>
                <button type="submit" id="send-btn" disabled>‚û§</button>
            </form>
        </main>
    </div>

    <script>
        const OLLAMA_API = "/api/chat";

        // Estado app
        let chats = JSON.parse(localStorage.getItem("fastgpt_chats") || "[]");
        let currentChatId = null;

        // Elementos DOM
        const sidebar = document.getElementById("sidebar");
        const chatList = document.getElementById("chat-list");
        const chatTitle = document.getElementById("chat-title");
        const messagesDiv = document.getElementById("messages");
        const inputMessage = document.getElementById("input-message");
        const sendBtn = document.getElementById("send-btn");
        const addChatBtn = document.getElementById("add-chat");
        const deleteChatBtn = document.getElementById("delete-chat");
        const toggleSidebarBtn = document.getElementById("toggle-sidebar-btn");

        // Funciones

        function saveChats() {
            localStorage.setItem("fastgpt_chats", JSON.stringify(chats));
        }

        function createChat(title = "Chat Nuevo") {
            const newChat = {
                id: Date.now().toString(),
                title,
                messages: []
            };
            chats.push(newChat);
            saveChats();
            return newChat.id;
        }

        function deleteChat(id) {
            chats = chats.filter(c => c.id !== id);
            saveChats();
            if (chats.length === 0) {
                currentChatId = createChat();
            } else {
                currentChatId = chats[0].id;
            }
            renderChatList();
            renderCurrentChat();
        }

        function setCurrentChat(id) {
            currentChatId = id;
            renderChatList();
            renderCurrentChat();
        }

        function renderChatList() {
            chatList.innerHTML = "";
            chats.forEach(chat => {
                const btn = document.createElement("button");
                btn.textContent = chat.title;
                btn.classList.add("list-group-item", "list-group-item-action");
                if (chat.id === currentChatId) btn.classList.add("active");
                btn.onclick = () => setCurrentChat(chat.id);
                chatList.appendChild(btn);
            });
        }

        function renderCurrentChat() {
            messagesDiv.innerHTML = "";
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;

            chatTitle.textContent = chat.title || "Chat Nuevo";
            chat.messages.forEach(msg => {
                appendMessage(msg.text, msg.sender);
            });

            scrollToBottom();
            inputMessage.value = "";
            sendBtn.disabled = false;
        }

        function appendMessage(text, sender) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message", sender === "user" ? "user" : "bot");
            msgDiv.textContent = text;
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTo({
                top: messagesDiv.scrollHeight,
                behavior: "smooth"
            });
        }

        async function sendMessage(text) {
            appendMessage(text, "user");
            updateCurrentChat(text, "user");
            sendBtn.disabled = true;

            try {
                const response = await fetch(OLLAMA_API, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        model: "llama3.1",
                        prompt: text
                    }),
                });

                const data = await response.json();
                if (data.error) {
                    appendMessage("Error: " + data.error, "bot");
                    updateCurrentChat("Error: " + data.error, "bot");
                } else {
                    const reply = data?.completion || data?.choices?.[0]?.message?.content || JSON.stringify(data);
                    appendMessage(reply, "bot");
                    updateCurrentChat(reply, "bot");
                }
            } catch (err) {
                appendMessage("Error de conexi√≥n.", "bot");
                updateCurrentChat("Error de conexi√≥n.", "bot");
            } finally {
                sendBtn.disabled = false;
            }
        }

        function updateCurrentChat(text, sender) {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            chat.messages.push({text, sender});
            saveChats();
        }

        // Eventos
        addChatBtn.onclick = () => {
            const newId = createChat();
            setCurrentChat(newId);
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        };

        deleteChatBtn.onclick = () => {
            if (confirm("¬øEliminar este chat?")) {
                deleteChat(currentChatId);
            }
        };

        toggleSidebarBtn.onclick = toggleSidebar;

        function toggleSidebar() {
            sidebar.classList.toggle("show");
            sidebar.classList.toggle("hide");
        }

        inputMessage.addEventListener("input", () => {
            sendBtn.disabled = inputMessage.value.trim().length === 0;
        });

        document.getElementById("input-area").addEventListener("submit", e => {
            e.preventDefault();
            const text = inputMessage.value.trim();
            if (!text) return;
            sendMessage(text);
            inputMessage.value = "";
        });

        // Init app
        if (chats.length === 0) {
            currentChatId = createChat();
        } else {
            currentChatId = chats[0].id;
        }

        renderChatList();
        renderCurrentChat();
    </script>

    <!-- Bootstrap 5 JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
